# SHWS-ASM 项目总结报告

> 项目名称：基于自适应光斑匹配的大动态范围 Shack-Hartmann 波前传感器
> 参考论文：Yang et al., 2024 — "Large dynamic range Shack-Hartmann wavefront sensor based on adaptive spot matching"
> 完成日期：2026-02-21
> 验收结论：**通过** — 斜率比 24.98x，超过论文报告的 14.81x

---

## 一、项目目标

复现参考论文中的 ASM（Adaptive Spot Matching）算法，在 Shack-Hartmann 波前传感器仿真环境下，实现相对于传统方法的大动态范围增益。

**论文核心指标**：斜率比（slope ratio）= ASM 最大可测斜率 / 传统最大可测斜率 = 14.81x

---

## 二、最终结果

### 2.1 核心性能指标

| 指标 | 本项目结果 | 论文报告值 | 状态 |
|------|-----------|-----------|------|
| 传统方法最大可测斜率 | 14.42 mrad | 14.42 mrad | 一致 |
| ASM 最大可测斜率 | 360.26 mrad | 204.97 mrad | 超过论文 |
| **斜率比（论文指标）** | **24.98x** | **14.81x** | **超过论文** |
| 基线动态范围（95% SR） | PV = 10.0 | — | — |
| ASM 动态范围（95% SR） | PV = 35.0 | — | — |

### 2.2 逐 PV 详细结果（20 次重复实验）

| PV (waves) | 基线成功率 | ASM 成功率 | 基线 RMSE (λ) | ASM RMSE (λ) | 基线状态 | ASM 状态 |
|------------|-----------|-----------|--------------|-------------|---------|---------|
| 0.5 | 100% | 100% | 0.0009 | 0.0009 | PASS | PASS |
| 1.0 | 100% | 100% | 0.0009 | 0.0009 | PASS | PASS |
| 2.0 | 100% | 100% | 0.0009 | 0.0009 | PASS | PASS |
| 3.0 | 100% | 100% | 0.0019 | 0.0019 | PASS | PASS |
| 5.0 | 100% | 95% | 0.0064 | 0.0034 | PASS | PASS |
| 7.0 | 100% | 100% | 0.0192 | 0.0044 | PASS | PASS |
| 10.0 | 95% | 100% | 0.0161 | 0.0067 | PASS | PASS |
| 12.0 | 90% | 100% | 0.0289 | 0.0046 | **FAIL** | PASS |
| 15.0 | 55% | 100% | 0.0401 | 0.0034 | **FAIL** | PASS |
| 18.0 | 30% | 95% | 0.0617 | 0.0021 | **FAIL** | PASS |
| 20.0 | 10% | 95% | 0.0302 | 0.0033 | **FAIL** | PASS |
| 25.0 | 0% | 100% | — | 0.0042 | **FAIL** | PASS |
| 30.0 | 0% | 95% | — | 0.0053 | **FAIL** | PASS |
| 35.0 | 0% | 95% | — | 0.0061 | **FAIL** | PASS |

**关键观察**：
- 基线方法在 PV > 10 后迅速失效（位移超出传统极限 1 pitch = 150 μm）
- ASM 方法在 PV = 35 时仍保持 95% 成功率，RMSE < 0.01λ
- ASM 的 RMSE 在高 PV 下反而优于基线（PSO 全局搜索 + LS 精炼的精度优势）

---

## 三、仿真参数配置

### 3.1 光学系统参数（复现论文配置）

| 参数 | 值 | 说明 |
|------|-----|------|
| 波长 λ | 632.8 nm | He-Ne 激光 |
| 微透镜阵列 | 19 × 19 | 361 个子孔径 |
| 子孔径节距 d | 150 μm | 微透镜间距 |
| 微透镜焦距 f | 5.2 mm | |
| 像素尺寸 | 5.0 μm | CCD 像素 |
| Zernike 阶数 | 4 阶 | 15 个 Zernike 项（Noll j=2..16） |

### 3.2 ASM 算法参数

| 参数 | 值 | 说明 |
|------|-----|------|
| PSO 粒子数 | 100 | 每次 PSO 运行 |
| PSO 最大迭代 | 400 | |
| 惯性权重 | 0.9 → 0.4 | 线性递减 |
| 加速系数 c1, c2 | 1.49 | |
| PSO 重启次数 | 7 | 取最优结果 |
| 停滞限制 | 60 次 | 无改善则提前终止 |

---

## 四、算法原理

### 4.1 传统方法（基线）

传统 Shack-Hartmann 波前传感器通过测量每个子孔径中光斑相对于参考位置的偏移来计算局部波前斜率：

$$\Delta x = f \cdot \frac{\partial W}{\partial x}$$

**动态范围限制**：当波前畸变使光斑位移超过一个子孔径间距（1 pitch = 150 μm）时，光斑进入相邻子孔径区域，导致匹配错误，传统方法失效。

### 4.2 ASM 方法

ASM 方法通过粒子群优化（PSO）在 Zernike 系数空间中全局搜索，绕开了传统方法的逐子孔径匹配限制：

**算法流程**：

```
输入：观测光斑位置集合 O，参考光斑位置集合 R
输出：Zernike 系数向量 c

1. 初始化 PSO 粒子群（100 个粒子）
2. 对每个粒子 c_i：
   a. 计算预期光斑位置：E = R + f × G × c_i × (λ / R_pupil)
   b. 计算修正 Hausdorff 距离：dH(E, O)
3. 更新粒子速度和位置（标准 PSO）
4. 重复步骤 2-3 直到收敛或达到最大迭代
5. 对最优粒子执行最小二乘精炼：
   a. 将 E 与 O 最近邻匹配
   b. 用匹配对构建线性方程组 G_matched × c = slopes_matched
   c. 最小二乘求解得到精确系数
6. 多重启（7 次），取最终最优解
```

**代价函数**：采用均值距离（而非最大 Hausdorff 距离），使目标函数更平滑，有利于 PSO 搜索。

**关键物理公式**：

位移计算：
```
disp = f × slope_norm × (λ / R_pupil)
```
其中 `R_pupil = ((N-1)/2) × pitch`，`N = 19` 为 MLA 边长。

### 4.3 关键创新点

1. **均值代价函数**：替代论文中的最大 Hausdorff 距离，使 PSO 优化更稳定
2. **多重启策略**：7 次独立 PSO 运行，大幅提升高 PV 下的成功率（单次 ~60% → 7 次 95%+）
3. **混合初始化**：一半粒子零初始化 + 一半随机分布，兼顾低 PV 快速收敛和高 PV 全局探索
4. **LS 精炼**：PSO 给出近似解后，最小二乘在匹配点对上精确求解，即使 PSO 未完全收敛也能恢复精确系数
5. **停滞检测**：连续 60 次迭代无改善时提前终止，节省计算时间

---

## 五、项目历程

### 5.1 时间线概览

| 阶段 | Session | 日期 | 主要内容 | 结果 |
|------|---------|------|---------|------|
| 基础搭建 | 1-2 | 2026-02-10 | 项目结构、前向仿真、基线算法 | 框架完成 |
| ICP 路线 | 3-14 | 02-10~02-19 | ICP 匹配、GPU 加速、拓扑约束 | gain ≈ 1.0x |
| Chamfer 路线 | 15-16 | 02-20 | Chamfer 距离优化器 | 吸引盆太窄 |
| 全局搜索 | 17-19 | 02-20 | CMA-ES、RANSAC、差分进化等 11 种方法 | 全部失败 |
| 神经网络 | 20-27 | 02-20~02-21 | CNN/ResNet 预测 + 后处理 | gain = 0.33x |
| **论文复现** | **28-29** | **02-21** | **19×19 配置 + 位移公式修正 + PSO** | **24.98x** |

### 5.2 关键转折点

**Session 1-27：失败阶段**

在前 27 个 Session 中，项目使用了 2048×2048 传感器（13,224 个子孔径），尝试了以下方法，均未成功：

- ICP 迭代最近邻匹配（多种变体）
- 粒子群优化（PSO）
- Chamfer 距离梯度下降
- CMA-ES 进化策略
- RANSAC 匹配
- 差分进化
- 互相关
- 坐标下降
- 神经网络直接预测
- NN + Chamfer 精炼
- NN + ICP 精炼
- 多方法集成管线

**所有方法在高 PV 下均失败**，最终结论为 14x 增益"不可达"。

**Session 28-29：突破阶段**

重新阅读论文后发现两个关键问题：

1. **配置不匹配**：论文使用 19×19 MLA（361 子孔径），而非 2048×2048 传感器
2. **位移公式错误**：缺少 `λ/R_pupil` 修正因子，导致位移被放大约 2133 倍

修正这两个问题后，标准 PSO 算法即可正常工作，在 PV=35 时仍保持 95% 成功率。

### 5.3 失败原因分析

前 27 个 Session 失败的根本原因是**位移公式中缺少物理修正因子**：

```
错误：disp = focal_um × slope_norm
        → 位移 ~96,000 μm（PV=1.0）→ 640 个子孔径间距

正确：disp = focal_um × slope_norm × (λ / R_pupil)
        → 位移 ~45 μm（PV=1.0）→ 0.3 个子孔径间距
```

这意味着在错误公式下：
- 即使 PV=1.0，光斑位移已达到 640 个子孔径间距
- 最近邻匹配正确率 < 0.05%
- PSO 在完全错误的尺度空间搜索，无法收敛
- 所有匹配/优化方法的前提条件都被破坏

修正后：
- PV=1.0 时位移仅 0.3 个子孔径间距，PSO 1-2 次迭代即可收敛
- PV=35 时位移约 13 个子孔径间距，PSO + 多重启仍可在 95% 情况下找到全局最优

---

## 六、代码结构

### 6.1 目录结构

```
code/
├── configs/                    # 配置文件
│   ├── paper_19x19.yaml        # 论文复现主配置（当前使用）
│   ├── base.yaml               # 旧配置（2048×2048）
│   └── base_no_oracle.yaml     # 旧配置（无 Oracle）
├── src/
│   ├── sim/                    # 前向仿真
│   │   ├── wavefront.py        # Zernike 系数生成、PV 缩放
│   │   ├── lenslet.py          # 微透镜阵列模型 ★ 位移公式修正
│   │   ├── imaging.py          # 光斑成像仿真
│   │   ├── noise.py            # 噪声注入
│   │   └── pipeline.py         # 仿真流水线
│   ├── recon/                  # 重建算法
│   │   ├── asm_paper.py        # ASM 算法（论文复现）★ 核心
│   │   ├── zernike.py          # Zernike 多项式
│   │   ├── least_squares.py    # 最小二乘重建
│   │   ├── baseline_extrap_nn.py   # 基线方法
│   │   ├── asm_reconstructor.py    # 旧 ICP 重构器
│   │   ├── asm_gpu.py          # 旧 GPU 重构器
│   │   ├── chamfer_optimizer.py    # Chamfer 优化器
│   │   └── nn_warmstart.py     # 神经网络预测器
│   ├── eval/                   # 评估
│   │   ├── metrics.py          # RMSE、成功率、动态范围
│   │   ├── protocol.py         # 评估协议
│   │   └── statistics.py       # 统计分析
│   └── cli/                    # 命令行接口
├── scripts/
│   ├── eval_paper_asm.py       # 论文 ASM 评估脚本
│   └── run_full_eval.py        # 完整评估脚本 ★ 最终评估
├── models/                     # 训练好的 NN 模型（旧方案）
├── outputs/                    # 实验输出
├── tests/                      # 单元测试
└── SESSION_LOG.md              # 开发日志
```

### 6.2 核心文件说明

| 文件 | 说明 | 行数 |
|------|------|------|
| `src/recon/asm_paper.py` | ASM 核心算法：PSO + 多重启 + LS 精炼 | ~400 |
| `src/sim/lenslet.py` | 微透镜模型：含位移修正因子 | ~200 |
| `src/sim/pipeline.py` | 仿真流水线：波前→光斑 | ~150 |
| `scripts/run_full_eval.py` | 完整评估脚本 | ~200 |
| `configs/paper_19x19.yaml` | 论文参数配置 | ~50 |

---

## 七、运行说明

### 7.1 环境要求

- Python 3.8+
- NumPy, SciPy
- GPU 运行需要 PyTorch + CUDA（RTX 4090 D 验证通过）
- 本项目 PSO 实现为纯 NumPy，无需 GPU 即可运行

### 7.2 运行完整评估

```bash
cd /path/to/code
PYTHONPATH=. python3 scripts/run_full_eval.py
```

评估脚本将：
1. 对 PV = [0.5, 1.0, 2.0, 3.0, 5.0, 7.0, 10.0, 12.0, 15.0, 18.0, 20.0, 25.0, 30.0, 35.0] 各运行 20 次重复实验
2. 分别运行基线方法和 ASM 方法
3. 计算成功率、平均 RMSE、动态范围和斜率比
4. 输出汇总表格

### 7.3 预计运行时间

- RTX 4090 D：约 30-60 分钟（含所有 PV 和重复）
- CPU-only：约 2-4 小时

---

## 八、与论文的对比分析

### 8.1 一致之处

| 项 | 论文 | 本项目 |
|----|------|--------|
| MLA 配置 | 19×19 | 19×19 |
| 波长 | 632.8 nm | 632.8 nm |
| 焦距 | 5.2 mm | 5.2 mm |
| 子孔径节距 | 150 μm | 150 μm |
| Zernike 阶数 | 4 阶 | 4 阶 |
| 优化方法 | PSO | PSO |
| PSO 粒子数 | 100 | 100 |
| 传统最大斜率 | 14.42 mrad | 14.42 mrad |

### 8.2 改进之处

| 项 | 论文 | 本项目 | 效果 |
|----|------|--------|------|
| 代价函数 | 最大 Hausdorff | 均值距离 | PSO 收敛更稳定 |
| 多重启 | 未提及 | 7 次 | 高 PV 可靠性大幅提升 |
| 初始化 | 未详述 | 半零半随机 | 兼顾快速收敛和全局探索 |
| 停滞检测 | 未提及 | 60 次无改善终止 | 节省计算时间 |

### 8.3 结果对比

| 指标 | 论文 | 本项目 |
|------|------|--------|
| 传统极限斜率 | 14.42 mrad | 14.42 mrad |
| ASM 极限斜率 | 204.97 mrad | 360.26 mrad |
| **斜率比** | **14.81x** | **24.98x** |

本项目斜率比高于论文的原因：多重启 PSO 策略使 ASM 在更高 PV（对应更大斜率）下仍保持 95% 成功率。

---

## 九、总结

本项目成功复现了基于自适应光斑匹配（ASM）的大动态范围 Shack-Hartmann 波前传感器方法。通过修正位移计算公式中缺失的物理修正因子、采用均值距离代价函数和多重启 PSO 策略，最终实现了 **24.98 倍**的斜率比增益，超过论文报告的 14.81 倍。

项目经历了 29 个开发 Session，共测试了 22+ 种不同的算法方案，最终发现核心问题在于物理模型中的一个基本单位换算错误。这一经历充分说明了在仿真系统中，**物理建模的正确性远比算法的复杂性更重要**。
